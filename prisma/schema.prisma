generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum BookingType {
  TOUR
  FLIGHT
  HOTEL
  VISA
  CHARTER_PACKAGE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  BANK
  PAYMOB
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ComplaintPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RoomType {
  SINGLE
  DOUBLE
  TRIPLE
  QUAD
}

enum PackageType {
  CHARTER
  INBOUND
  REGULAR
}

model User {
  id          String    @id @default(cuid())
  clerkId     String    @unique
  email       String    @unique
  name        String?
  phone       String?
  role        UserRole  @default(USER)
  lastLoginAt DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  bookings              Booking[]
  reviews               Review[]
  complaints            Complaint[]
  blogs                 Blog[]
  activityLogs          ActivityLog[]
  charterPackageReviews CharterPackageReview[]

  @@index([clerkId])
  @@index([email])
  @@index([isActive])
}

model Tour {
  id               String    @id @default(cuid())
  title            String
  slug             String    @unique
  description      String    @db.Text
  shortDescription String    @db.Text
  price            Decimal   @db.Decimal(10, 2)
  discountPrice    Decimal?  @db.Decimal(10, 2)
  currency         String    @default("EGP")
  duration         Int
  maxGroupSize     Int?
  minGroupSize     Int       @default(1)
  images           Json
  itinerary        Json?
  destination      String
  category         String
  difficulty       String?
  isActive         Boolean   @default(true)
  isFeatured       Boolean   @default(false)
  startDate        DateTime?
  endDate          DateTime?
  availableSpots   Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  bookings Booking[]
  reviews  Review[]

  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([category])
}

model Flight {
  id             String   @id @default(cuid())
  flightNumber   String
  airline        String
  origin         String
  destination    String
  departureDate  DateTime
  arrivalDate    DateTime
  price          Decimal  @db.Decimal(10, 2)
  currency       String   @default("EGP")
  availableSeats Int
  amadeusOfferId String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bookings Booking[]

  @@index([origin, destination])
  @@index([departureDate])
  @@index([isActive])
}

model Hotel {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String   @db.Text
  address      String
  city         String
  country      String
  latitude     Float?
  longitude    Float?
  placeId      String?
  rating       Float?
  amenities    Json
  images       Json
  checkInTime  String?
  checkOutTime String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  bookings              Booking[]
  reviews               Review[]
  charterPackageOptions CharterPackageHotelOption[]

  @@index([slug])
  @@index([city, country])
  @@index([isActive])
}

model Visa {
  id                String   @id @default(cuid())
  country           String
  type              String
  description       String   @db.Text
  price             Decimal  @db.Decimal(10, 2)
  currency          String   @default("EGP")
  processingTime    String
  requiredDocuments Json
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  bookings Booking[]

  @@index([country])
  @@index([isActive])
}

model Booking {
  id                       String         @id @default(cuid())
  userId                   String
  bookingType              BookingType
  tourId                   String?
  flightId                 String?
  hotelId                  String?
  visaId                   String?
  charterPackageId         String?
  status                   BookingStatus  @default(PENDING)
  totalAmount              Decimal        @db.Decimal(10, 2)
  currency                 String         @default("EGP")
  paymentStatus            PaymentStatus  @default(PENDING)
  paymentMethod            PaymentMethod?
  paymentTransactionId     String?
  bookingDate              DateTime       @default(now())
  travelDate               DateTime?
  guestDetails             Json
  flightOfferData          Json?
  charterHotelOptionId     String?
  charterDepartureOptionId String?
  roomType                 String?
  numberOfAdults           Int?
  numberOfChildren6to12    Int?
  numberOfChildren2to6     Int?
  numberOfInfants          Int?
  selectedAddonIds         Json?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt

  user                   User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour                   Tour?                      @relation(fields: [tourId], references: [id], onDelete: SetNull)
  flight                 Flight?                    @relation(fields: [flightId], references: [id], onDelete: SetNull)
  hotel                  Hotel?                     @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  visa                   Visa?                      @relation(fields: [visaId], references: [id], onDelete: SetNull)
  charterPackage         CharterTravelPackage?      @relation(fields: [charterPackageId], references: [id], onDelete: SetNull)
  charterHotelOption     CharterPackageHotelOption? @relation(fields: [charterHotelOptionId], references: [id], onDelete: SetNull)
  charterDepartureOption CharterDepartureOption?    @relation(fields: [charterDepartureOptionId], references: [id], onDelete: SetNull)

  complaints Complaint[]

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([bookingType])
}

model Review {
  id           String   @id @default(cuid())
  userId       String
  tourId       String?
  hotelId      String?
  rating       Int
  title        String?
  comment      String?  @db.Text
  images       Json?
  isVerified   Boolean  @default(false)
  isApproved   Boolean  @default(false)
  helpfulCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour  Tour?  @relation(fields: [tourId], references: [id], onDelete: Cascade)
  hotel Hotel? @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@index([tourId])
  @@index([hotelId])
  @@index([isApproved])
  @@index([rating])
}

model Complaint {
  id            String            @id @default(cuid())
  userId        String
  bookingId     String?
  subject       String
  description   String            @db.Text
  category      String
  status        ComplaintStatus   @default(OPEN)
  priority      ComplaintPriority @default(MEDIUM)
  adminResponse String?           @db.Text
  resolvedAt    DateTime?
  attachments   Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
}

model Blog {
  id             String    @id @default(cuid())
  title          String
  slug           String    @unique
  content        String    @db.Text
  excerpt        String?   @db.Text
  featuredImage  String?
  authorId       String
  category       String?
  tags           Json?
  isPublished    Boolean   @default(false)
  publishedAt    DateTime?
  seoTitle       String?
  seoDescription String?   @db.Text
  readingTime    Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isPublished])
  @@index([category])
  @@index([authorId])
}

model EmailNotification {
  id           String    @id @default(cuid())
  userId       String?
  type         String
  subject      String
  status       String
  sentAt       DateTime?
  errorMessage String?   @db.Text
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([type])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model CharterTravelPackage {
  id                 String      @id @default(cuid())
  type               PackageType @default(CHARTER)
  name               String
  slug               String      @unique
  description        String      @db.Text
  shortDescription   String      @db.Text
  destinationCountry String
  destinationCity    String
  nights             Int
  days               Int
  mainImage          String?
  gallery            Json
  basePrice          Decimal?    @db.Decimal(10, 2)
  priceRangeMin      Decimal?    @db.Decimal(10, 2)
  priceRangeMax      Decimal?    @db.Decimal(10, 2)
  currency           String      @default("EGP")
  discount           Decimal?    @db.Decimal(5, 2)
  typeConfig         Json? // Type-specific configuration (flexible JSON)
  isActive           Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  departureOptions  CharterDepartureOption[]
  hotelOptions      CharterPackageHotelOption[]
  addons            CharterPackageAddon[]
  includedServices  Json
  excludedServices  Json
  excursionProgram  Json
  requiredDocuments Json
  bookings          Booking[]
  reviews           CharterPackageReview[]

  @@index([type])
  @@index([slug])
  @@index([isActive])
  @@index([destinationCountry, destinationCity])
  @@index([type, isActive])
  @@index([isActive, destinationCountry, destinationCity])
  @@index([isActive, priceRangeMin, priceRangeMax])
  @@index([isActive, nights, days])
  @@index([isActive, type, destinationCountry])
}

model CharterDepartureOption {
  id               String   @id @default(cuid())
  packageId        String
  departureAirport String
  arrivalAirport   String
  departureDate    DateTime
  returnDate       DateTime
  flightInfo       String?  @db.Text
  priceModifier    Decimal? @db.Decimal(10, 2)
  currency         String   @default("EGP")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  package       CharterTravelPackage    @relation(fields: [packageId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  hotelPricings DepartureHotelPricing[]

  @@index([packageId])
  @@index([departureDate])
}

model CharterPackageHotelOption {
  id                 String   @id @default(cuid())
  packageId          String
  hotelId            String
  starRating         Int?
  bookingRating      Float?
  distanceFromCenter Float?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  package       CharterTravelPackage    @relation(fields: [packageId], references: [id], onDelete: Cascade)
  hotel         Hotel                   @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  hotelPricings DepartureHotelPricing[]

  @@index([packageId])
  @@index([hotelId])
}

model CharterPackageAddon {
  id          String   @id @default(cuid())
  packageId   String
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("EGP")
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  package CharterTravelPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
}

model CharterPackageReview {
  id           String   @id @default(cuid())
  userId       String
  packageId    String
  rating       Int
  title        String?
  comment      String?  @db.Text
  images       Json?
  isVerified   Boolean  @default(false)
  isApproved   Boolean  @default(false)
  helpfulCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  package CharterTravelPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
  @@index([isApproved])
  @@index([rating])
}

model DepartureHotelPricing {
  id                String   @id @default(cuid())
  departureOptionId String
  hotelOptionId     String
  currency          String   @default("EGP")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  departureOption  CharterDepartureOption    @relation(fields: [departureOptionId], references: [id], onDelete: Cascade)
  hotelOption      CharterPackageHotelOption @relation(fields: [hotelOptionId], references: [id], onDelete: Cascade)
  roomTypePricings RoomTypePricing[]

  @@unique([departureOptionId, hotelOptionId])
  @@index([departureOptionId])
  @@index([hotelOptionId])
}

model RoomTypePricing {
  id                      String   @id @default(cuid())
  departureHotelPricingId String
  roomType                RoomType
  adultPrice              Decimal  @db.Decimal(10, 2)
  childPrice6to12         Decimal? @db.Decimal(10, 2)
  childPrice2to6          Decimal? @db.Decimal(10, 2)
  infantPrice             Decimal? @db.Decimal(10, 2)
  currency                String   @default("EGP")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  departureHotelPricing DepartureHotelPricing @relation(fields: [departureHotelPricingId], references: [id], onDelete: Cascade)

  @@unique([departureHotelPricingId, roomType])
  @@index([departureHotelPricingId])
}

model Branch {
  id          String   @id @default(cuid())
  name        String   // e.g., "Cairo Main Office", "Alexandria Branch"
  slug        String   @unique // URL-friendly identifier
  address     String   @db.Text // Full address
  city        String
  country     String
  latitude    Float?
  longitude   Float?
  placeId     String?  // Google Places ID
  phone       String   // Primary phone number
  phoneAlt    String?  // Alternative phone number
  email       String   // Primary email
  emailAlt    String?  // Alternative email
  workingHours Json    // { monday: "9:00 AM - 5:00 PM", tuesday: "9:00 AM - 5:00 PM", ... }
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0) // For ordering branches
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
  @@index([slug])
}
